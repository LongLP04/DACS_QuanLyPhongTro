@model IEnumerable<DACS_QuanLyPhongTro.Models.KhachThue>
@{
    ViewData["Title"] = "Chat với khách thuê";
    Layout = "~/Areas/ChuTroArea/Views/Shared/layoutAdminLTE.cshtml";
}
<div class="container py-4">
    <h2 class="mb-4">Chat với khách thuê</h2>
    <div class="row">
        <div class="col-md-4">
            <div class="list-group" id="userList">
                @foreach (var user in Model)
                {
                    <button type="button" class="list-group-item list-group-item-action" data-userid="@user.ApplicationUserId">
                        <i class="fas fa-user me-2"></i>@user.HoTen
                    </button>
                }
            </div>
        </div>
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <span id="chatWith">Chọn khách thuê để bắt đầu chat</span>
                </div>
                <div class="card-body" id="chatMessages" style="height:350px; overflow-y:auto; background:#f8f9fa;"></div>
                <div class="card-footer">
                    <form id="chatForm" class="d-flex gap-2">
                        <input type="text" id="messageInput" class="form-control" placeholder="Nhập tin nhắn..." autocomplete="off" disabled />
                        <button type="submit" class="btn btn-primary" disabled id="sendBtn">Gửi</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        let connection = new signalR.HubConnectionBuilder().withUrl("/chathub").build();
        let selectedUserId = null;
        const userList = document.getElementById('userList');
        const chatWith = document.getElementById('chatWith');
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        // Kết nối SignalR
        messageInput.disabled = true;
        sendBtn.disabled = true;
        connection.start().then(() => {
            // Cho phép nhập và gửi khi đã kết nối
            if (selectedUserId) {
                messageInput.disabled = false;
                sendBtn.disabled = false;
            }
        }).catch(err => {
            messageInput.disabled = true;
            sendBtn.disabled = true;
            console.error(err.toString());
        });
        // Nhận tin nhắn
        connection.on("ReceiveMessage", function(senderId, message, isGroup) {
            const div = document.createElement('div');
            div.className = 'mb-2';
            div.innerHTML = `<span class='fw-bold'>${senderId === selectedUserId ? 'Khách' : 'Bạn'}:</span> ${message}`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });
        // Chọn khách thuê để chat
        userList.addEventListener('click', function(e) {
            if (e.target.closest('button[data-userid]')) {
                selectedUserId = e.target.closest('button').getAttribute('data-userid');
                chatWith.textContent = 'Chat với khách thuê';
                messageInput.disabled = false;
                sendBtn.disabled = false;
                loadChatHistory();
            }
        });
        // Hàm load lịch sử chat
        function loadChatHistory() {
            if (!selectedUserId) return;
            fetch('/ChuTroArea/Chat/GetChatHistory?userId=' + selectedUserId)
                .then(res => res.json())
                .then(data => {
                    chatMessages.innerHTML = '';
                    data.forEach(m => {
                        const div = document.createElement('div');
                        if (m.senderId === selectedUserId) {
                            div.className = 'mb-2';
                            div.innerHTML = `<span class='fw-bold'>Khách:</span> ${m.content}`;
                        } else {
                            div.className = 'mb-2 text-end';
                            div.innerHTML = `<span class='fw-bold'>Bạn:</span> ${m.content}`;
                        }
                        chatMessages.appendChild(div);
                    });
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
        }
        // Gửi tin nhắn
        document.getElementById('chatForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const msg = messageInput.value.trim();
            if (!msg || !selectedUserId || connection.state !== 'Connected') return;
            connection.invoke("SendPrivateMessage", selectedUserId, msg);
            messageInput.value = '';
        });
    </script>
}
